stages:
  - list_image

list_image:
  stage: list_image
  script:
    - export AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID"
    - export AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY"
    - export AWS_DEFAULT_REGION="$AWS_DEFAULT_REGION"
    - |
      ECR_NAMESPACE="kc-abc"
      REPOS=$(aws ecr describe-repositories --repository-names $(aws ecr describe-repositories --query "repositories[].repositoryName" --output text) --query "repositories[].repositoryName" --output text | grep "^$ECR_NAMESPACE")
      for REPO in $REPOS; do
          IMAGE_TAGS=$(aws ecr list-images --repository-name $REPO --query 'imageIds[*]' --output json)
          for IMAGE_TAG in $IMAGE_TAGS; do
              if [[ "$IMAGE_TAG" == "null" ]]; then
                  IMAGE_TAG="none"
              fi
              SERVICES=$(aws ecs list-services --cluster <your-ecs-cluster-name> --query "serviceArns[*]" --output text --region <your-region> | xargs -n 1 aws ecs describe-services --services | jq -r ".services[].taskDefinition")
              for SERVICE in $SERVICES; do
                  TASK_DEFINITION=$(aws ecs describe-task-definition --task-definition $SERVICE)
                  if [[ $(echo "$TASK_DEFINITION" | grep "$REPO:$IMAGE_TAG") == "" ]]; then
                      echo "Unused Image: $REPO:$IMAGE_TAG"
                  fi
              done
          done
      done
